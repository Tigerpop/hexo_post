---
layout: posts
title: "17-eth 智能合约"
date: 2025-01-10 21:16:12
description: "这是文章开头，显示在主页面，详情请点击此处。"
categories: 
- "区块链"
tags:
- "eth"


---

简介 <!--more-->



eth 的智能合约是用 solidity 编写的，很像 Java  Script。

# 一个拍卖案例

一个拍卖案例，一个类吧。

![截屏2025-01-08 20.33.03](17-eth%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/%E6%88%AA%E5%B1%8F2025-01-08%2020.33.03.png)

![截屏2025-01-08 20.40.12](17-eth%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/%E6%88%AA%E5%B1%8F2025-01-08%2020.40.12.png)

> 上面的 mapping 是一个 address 到 uint 的映射， 名叫 bids（其实是个 hash 表），但是solidity中的 hash表不支持遍历，如果想要遍历，需要用别的东西来记录。上面的例子中用的是 数组 bidders 来记录。





# 调用智能合约

**外部账户没有代码，只有合约账户有代码！**

## 外部账户调用合约函数

如果A B都是普通账户，A —> B 就是一个普通的转账交易；

但是如果A B是合约账户 ，A —> B  就是一个对B合约的调用。

![截屏2025-01-08 21.06.35](17-eth%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/%E6%88%AA%E5%B1%8F2025-01-08%2021.06.35.png)

sender address 是发起的地址，to contract address 是被调用的合约的地址，Tx DATA 是被调用的函数。



## 合约调用另一个合约中的函数

### 直接调用

![截屏2025-01-08 21.13.04](17-eth%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/%E6%88%AA%E5%B1%8F2025-01-08%2021.13.04.png)

A 合约中 有一个 事件作记录用的，在方法中 用 emit 调用这个事件作log。

B 合约中，方法的参数是一个地址，方法中传入地址构建了一个A的对象的实例a，然后调用a对象的方法foo。

> eth 中规定，一次交易只能由外部账户发起，不能由合约账户主动发起。
> 按照上面的例子，只能由 一个外部账户对象调了 B 合约账户的方法callAFooDirectly，通过这个方法调用A合约账户中的 foo 方法，而不是是直接由B账户来直接发起。

### addr的call调用

![截屏2025-01-08 21.25.42](17-eth%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/%E6%88%AA%E5%B1%8F2025-01-08%2021.25.42.png)

这种写法好在可以避免被调用的合约异常导致 调用者的合约也报异常。

### 代理调用

![截屏2025-01-08 21.36.07](17-eth%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/%E6%88%AA%E5%B1%8F2025-01-08%2021.36.07.png)

这样可以在当前的合约中执行，避免进入被调用的合约环境。



![截屏2025-01-08 20.33.03](17-eth%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/%E6%88%AA%E5%B1%8F2025-01-08%2020.33.03.png)

一个eth 方法要接受外部转账就要写 payable。

**这个拍卖例子中，调用 bid() 方法时，出价人要把 出价的币 转到这个合约账户中，比如你叫100个eth 就要实质性的转100个eth 过去，锁定在合约内直到拍卖结束。**

拍卖结束以后，没有竞拍到的人调用 withdraw 方法，把竞拍时锁定的币取回来，不需要接受外部转账所以不用写 payable。

![截屏2025-01-08 21.53.03](17-eth%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/%E6%88%AA%E5%B1%8F2025-01-08%2021.53.03.jpg)

以前面这个转账的例子看，value 转的是0 ，没有实质性的转入，所以转账的方法 也不需要 payable。



![截屏2025-01-08 21.54.40](17-eth%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/%E6%88%AA%E5%B1%8F2025-01-08%2021.54.40.png)

正常：**A调用B这个合约，需要在转账交易的data 域中说明，A调用的是B合约中的哪一个函数。 **

特例： A 转了一笔钱到B合约中，但是data 域内没有说明，要调用 fallback 函数，还要有payable标注。

